var MongoClient,ObjectID,Q,chainedEventsCollection,createEvent,deleteEvent,deleteScheduledEvent,getDB,getEventToSave,retrieveChainedEvent,retrieveEvent,retrieveEvents,retrieveEventsByQuery,retrieveScheduledEvent,retrieveScheduledEvents,retrieveScheduledEventsByUser,saveScheduledEvent,schedule,scheduledEventsCollection,tracedEventsCollection,updateEvent,updateScheduledEventAfterError,updateScheduledEventAfterExecution,uri;schedule=require("node-schedule"),Q=require("q"),MongoClient=require("mongodb").MongoClient,ObjectID=require("mongodb").ObjectID,uri=process.env.MONGOLAB_URI,scheduledEventsCollection="scheduledEvents",chainedEventsCollection="chainedEvents",tracedEventsCollection="tracedEvents",getDB=function(e){return MongoClient.connect(uri,function(t,n){if(t)throw t;return e(n)})},saveScheduledEvent=function(e,t,n,r,o,v,d){var i;return i={user:t,dateTime:new Date(n).getTime(),eventType:r,eventParams:d,providers:o,providersOptions:v,eventId:e,chainedEventsCounts:0},createEvent(i,scheduledEventsCollection)},exports.createChainedEvent=function(e,t,n,r,o,v){var d;return d={user:t,eventType:n,eventParams:v,providers:r,eventParentId:e,providersOptions:o},createEvent(d,chainedEventsCollection,function(){return updateEvent(e,{$inc:{chainedEventsCounts:1}},scheduledEventsCollection)})},createEvent=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){return o.collection(t).insert(e,function(t,v){return o.close(),t?r.reject(new Error(t)):(void 0!==n&&n(v),r.resolve(e.eventId))})}),r.promise},exports.createTracedEvent=function(e,t,n,r,o,v){var d;return d=getEventToSave(e,t,n,r,o),d.results=v,createEvent(d,tracedEventsCollection)},exports.createTracedEventError=function(e,t,n,r,o,v){var d;return d=getEventToSave(e,t,n,r,o),d.error=v,createEvent(d,tracedEventsCollection)},getEventToSave=function(e,t,n,r,o){return eventToSave({user:e,dateTime:(new Date).getTime(),eventType:t,eventParams:n,providers:r,providersOptions:o})},exports.updateScheduledEvent=function(e,t){return delete t._id,updateEvent({eventId:e},t,scheduledEventsCollection)},updateScheduledEventAfterExecution=function(e,t){return updateEvent({eventId:e},{$set:{results:t}},scheduledEventsCollection)},updateScheduledEventAfterError=function(e,t){return updateEvent({eventId:e},{$set:{error:t.toString()}},scheduledEventsCollection)},exports.updateChainedEventAfterExecution=function(e,t){return updateEvent({_id:new ObjectID(e)},{$set:{results:t}},chainedEventsCollection)},exports.updateChainedEventAfterError=function(e,t){return updateEvent({_id:new ObjectID(e)},{$set:{error:t.toString()}},chainedEventsCollection)},updateEvent=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){return o.collection(n).update(e,t,function(e,t){return o.close(),e?r.reject(e):r.resolve(t.result.nModified)})}),r.promise},deleteScheduledEvent=function(e){return deleteEvent({eventId:e},scheduledEventsCollection)},exports.deleteChainedEvent=function(e,t){var n;return n={_id:new ObjectID(e)},deleteEvent(n,chainedEventsCollection,function(e){return 1===e.result.ok?updateEvent(t,{$inc:{chainedEventsCounts:-1}},scheduledEventsCollection):void 0})},exports.deleteTracedEvent=function(e){var t;return t={_id:new ObjectID(e)},deleteEvent(t,tracedEventsCollection)},deleteEvent=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){return o.collection(t).remove(e,function(e,t){return o.close(),e?r.reject(new Error(e)):(void 0!==n&&n(t),r.resolve(t.result.n))})}),r.promise},retrieveScheduledEvents=function(){return retrieveEvents(scheduledEventsCollection)},exports.retrieveChainedEvents=function(e){return retrieveEvents(chainedEventsCollection,[{name:"eventParentId",value:e}])},retrieveEvents=function(e,t){var n,r,o,v,d;if(n=Q.defer(),d={results:{$exists:!1},error:{$exists:!1}},void 0!==t)for(r=0,o=t.length;o>r;r++)v=t[r],d[v.name]=v.value;return getDB(function(t){return t.collection(e).find(d).toArray(function(e,r){return t.close(),e?n.reject(new Error(e)):n.resolve(r)})}),n.promise},retrieveScheduledEventsByUser=function(e){return retrieveEventsByQuery({user:e},scheduledEventsCollection,"dateTime")},exports.retrieveTracedEventsByUser=function(e){return retrieveEventsByQuery({user:e},tracedEventsCollection,"dateTime")},exports.retrieveChainedEvents=function(e){return retrieveEventsByQuery({eventParentId:e},chainedEventsCollection)},retrieveEventsByQuery=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){var v;return v={},n&&(v={sort:n}),o.collection(t).find(e,v).toArray(function(e,t){return o.close(),e?r.reject(new Error(e)):r.resolve(t)})}),r.promise},retrieveScheduledEvent=function(e){return retrieveEvent({eventId:e},scheduledEventsCollection)},retrieveChainedEvent=function(e){return retrieveEvent({_id:new ObjectID(e)},chainedEventsCollection)},retrieveEvent=function(e,t){var n;return n=Q.defer(),getDB(function(r){return r.collection(t).findOne(e,function(e,t){return r.close(),e?n.reject(new Error(e)):n.resolve(t)})}),n.promise},exports.saveScheduledEvent=saveScheduledEvent,exports.deleteScheduledEvent=deleteScheduledEvent,exports.retrieveScheduledEventsByUser=retrieveScheduledEventsByUser,exports.updateScheduledEventAfterExecution=updateScheduledEventAfterExecution,exports.updateScheduledEventAfterError=updateScheduledEventAfterError,exports.retrieveScheduledEvent=retrieveScheduledEvent,exports.retrieveChainedEvent=retrieveChainedEvent,exports.retrieveScheduledEvents=retrieveScheduledEvents;