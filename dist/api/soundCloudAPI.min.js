var CLIENT_ID,CLIENT_SECRET,Q,REDIRECT_URI,fs,http,https,querystring,request;https=require("https"),http=require("http"),request=require("request"),Q=require("q"),fs=require("fs"),querystring=require("querystring"),CLIENT_ID=process.env.SOUNDCLOUD_CLIENT_ID,CLIENT_SECRET=process.env.SOUNDCLOUD_CLIENT_SECRET,REDIRECT_URI=process.env.APP_URL+"/soundcloud2callback",exports.getOAuthURL=function(){return"https://soundcloud.com/connect?client_id="+CLIENT_ID+"&redirect_uri="+REDIRECT_URI+"&response_type=code"},exports.pushCode=function(e,o){var t,r,n,s;return console.log("pushing code: ",e),t=Q.defer(),r=querystring.stringify({client_id:CLIENT_ID,client_secret:CLIENT_SECRET,redirect_uri:REDIRECT_URI,grant_type:"authorization_code",code:e}),s={host:"api.soundcloud.com",port:443,path:"/oauth2/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":r.length}},n=https.request(s,function(e){var o;return console.log("sound cloud code validation statusCode: ",e.statusCode),o="",e.on("data",function(e){return o+=e}),e.on("end",function(){return console.log("soundcloud code validated ? ",o),o?t.resolve(JSON.parse(o)):t.reject(new Error("No data returned by soundloud"))})}),n.on("error",function(e){return console.log("soundcloud authentication error: ",e),t.reject(e)}),n.write(r),n.end(),t.promise},exports.getUserInfo=function(e){var o,t,r;return o=Q.defer(),r={host:"api.soundcloud.com",path:"/me/?oauth_token="+e.access_token,method:"GET"},t=https.request(r,function(e){var t;return t="",e.on("data",function(e){return t+=e}),e.on("end",function(){var e;return e=JSON.parse(t),e.error?(console.log("soundcloud authentication error: ",e.error.message),o.reject(e.error)):o.resolve({userName:e.username,id:e.id})})}),t.on("error",function(e){return console.log("soundcloud authentication error: ",e),o.reject(e)}),t.end(),o.promise},exports.sendMusic=function(e,o,t){var r;return console.log("Soundcloud sendMusic"),r=Q.defer(),request({method:"POST",json:!0,uri:"https://api.soundcloud.com/tracks",formData:{oauth_token:e.access_token,asset_data:fs.createReadStream(o.path),title:t.title,sharing:"private"}},function(e,o,t){return e?r.reject(e):(console.log("Soundcloud Upload Response body: ",t),console.log("response.statusCode: ",o.statusCode),o.statusCode>=400?r.reject(t):r.resolve(JSON.parse(t)))}),r.promise},exports.listMedia=function(e){var o,t,r;return o=Q.defer(),r={host:"api.soundcloud.com",path:"/me/tracks?oauth_token="+e.access_token,method:"GET"},t=https.request(r,function(e){var t;return t="",e.on("data",function(e){return t+=e}),e.on("end",function(){var e,r,n,s;return s=JSON.parse(t),s.error?(console.log("soundcloud list musics error: ",s.error.message),o.reject(s.error)):(e={playback:0,download:0,like:0,comment:0},r=function(o){return{name:o,value:e[o]}},n=s.map(function(o){return e.playback+=o.playback_count,e.download+=o.download_count,e.like+=o.favoritings_count,e.comment+=o.comment_count,result({id:o.id,title:o.title,creationDate:new Date(o.created_at),permalinkURL:o.permalink_url,thumbnailURL:o.artwork_url,description:o.description,counts:{playback:o.playback_count,download:o.download_count,like:o.favoritings_count,comment:o.comment_count}})}),o.resolve({list:n,stats:[r("playback"),r("download"),r("like"),r("comment")]}))})}),t.on("error",function(e){return console.log("soundcloud authentication error: ",e),o.reject(e)}),t.end(),o.promise};