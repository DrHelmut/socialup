var APP_KEY,APP_SECRET,Q,REDIRECT_URL,TOKEN,TOKEN_SECRET,bodyToTokens,createSignature,createSignatureBaseString,createSigningKey,crypto,fs,getAccessToken,getOAuthURL,getSignature,getTokens,getTweets,getUserInfo,http,https,inLineParams,oAuthNonce,percentEncode,postMessage,processGetRequest,querystring,request;https=require("https"),http=require("http"),request=require("request"),Q=require("q"),fs=require("fs"),querystring=require("querystring"),oAuthNonce=require("./oauth_nonce.js"),crypto=require("crypto"),APP_KEY=process.env.TWITTER_APP_KEY,APP_SECRET=process.env.TWITTER_APP_SECRET,REDIRECT_URL=process.env.APP_URL+"/twitter2callback?state=",TOKEN=process.env.TWITTER_ACCESS_TOKEN,TOKEN_SECRET=process.env.TWITTER_ACCESS_TOKEN_SECRET,getOAuthURL=function(){return"https://api.twitter.com/oauth/authorize"},getTokens=function(e){var t,r,o;return t=Q.defer(),r={oauth_callback:REDIRECT_URL+e,oauth_consumer_key:APP_KEY,oauth_nonce:oAuthNonce(),oauth_signature_method:"HMAC-SHA1",oauth_timestamp:Math.round(new Date/1e3),oauth_token:TOKEN,oauth_version:"1.0"},o="https://api.twitter.com/oauth/request_token",r.oauth_signature=getSignature(r,"post",o,TOKEN_SECRET,APP_SECRET),request({uri:o,headers:{Authorization:"OAuth "+inLineParams(r)},method:"POST"},function(e,r,o){return e?t.reject(e):t.resolve(bodyToTokens(o))}),t.promise},inLineParams=function(e){var t,r,o,n,s;for(o=Object.keys(e),o.sort(),s="",t=0,n=o.length;n>t;t++)r=o[t],s+=r+'="'+percentEncode(e[r])+'",';return s.substring(0,s.length-1)},createSignatureBaseString=function(e,t,r){var o,n,s,u,a;for(s=Object.keys(e),s.sort(),a="",o=0,u=s.length;u>o;o++)n=s[o],a+="&"+n+"="+percentEncode(e[n]);return t.toUpperCase()+"&"+percentEncode(r)+"&"+percentEncode(a.substring(1))},createSigningKey=function(e,t){return percentEncode(e)+"&"+percentEncode(t)},createSignature=function(e,t){var r;return r=crypto.createHmac("sha1",t),r.update(e).digest("base64")},getSignature=function(e,t,r,o,n){var s;return s=createSignatureBaseString(e,t,r),createSignature(s,createSigningKey(n,o))},percentEncode=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)})},getAccessToken=function(e,t){var r,o,n,s;return r=Q.defer(),o={oauth_consumer_key:APP_KEY,oauth_nonce:oAuthNonce(),oauth_signature_method:"HMAC-SHA1",oauth_timestamp:Math.round(new Date/1e3),oauth_token:t.oauth_token,oauth_version:"1.0"},s="https://api.twitter.com/oauth/access_token",n=t.oauth_token_secret,void 0===n&&(n=TOKEN_SECRET),o.oauth_signature=getSignature(o,"post",s,n,APP_SECRET),request({uri:s,headers:{Authorization:"OAuth "+inLineParams(o)},method:"POST",form:{oauth_verifier:e}},function(e,t,o){return e?r.reject(e):r.resolve(bodyToTokens(o))}),r.promise},postMessage=function(e,t){var r,o,n,s;return r=Q.defer(),n={oauth_consumer_key:APP_KEY,oauth_nonce:oAuthNonce(),oauth_signature_method:"HMAC-SHA1",oauth_timestamp:Math.round(new Date/1e3),oauth_token:e.oauth_token,oauth_version:"1.0"},o=n,o.status=t,s="https://api.twitter.com/1.1/statuses/update.json",n.oauth_signature=getSignature(o,"post",s,e.oauth_token_secret,APP_SECRET),request({uri:s,headers:{Authorization:"OAuth "+inLineParams(n)},method:"POST",form:{status:t}},function(e,t,o){var n;return e?r.reject(e):(n=JSON.parse(o),s="https://twitter.com/"+n.user.screen_name+"/status/"+n.id_str,console.log("tweet published: ",s),r.resolve({url:s}))}),r.promise},getTweets=function(e){var t,r,o,n;return t=Q.defer(),o={oauth_consumer_key:APP_KEY,oauth_nonce:oAuthNonce(),oauth_signature_method:"HMAC-SHA1",oauth_timestamp:Math.round(new Date/1e3),oauth_token:e.oauth_token,oauth_version:"1.0"},r=o,r.user_id=e.user_id,n="https://api.twitter.com/1.1/statuses/user_timeline.json",o.oauth_signature=getSignature(r,"get",n,e.oauth_token_secret,APP_SECRET),request({uri:n+"?user_id="+e.user_id,headers:{Authorization:"OAuth "+inLineParams(o)},method:"GET"},function(e,r,o){return e?t.reject(e):t.resolve(r)}),t.promise},exports.verifyCredentials=function(e){return processGetRequest(e,"https://api.twitter.com/1.1/account/verify_credentials.json",function(e,t){return t.statusCode})},getUserInfo=function(e){return processGetRequest(e,"https://api.twitter.com/1.1/account/settings.json",function(e){var t;return t=JSON.parse(e),{userName:t.screen_name}})},processGetRequest=function(e,t,r){var o,n,s;return o=Q.defer(),s={oauth_consumer_key:APP_KEY,oauth_nonce:oAuthNonce(),oauth_signature_method:"HMAC-SHA1",oauth_timestamp:Math.round(new Date/1e3),oauth_token:e.oauth_token,oauth_version:"1.0"},n=s,s.oauth_signature=getSignature(n,"get",t,e.oauth_token_secret,APP_SECRET),request({uri:t,headers:{Authorization:"OAuth "+inLineParams(s)},method:"GET"},function(e,t,n){return e?o.reject(e):o.resolve(r(n,t))}),o.promise},bodyToTokens=function(e){var t,r,o,n,s,u;for(s=e.split("&"),u={},r=0,o=s.length;o>r;r++)n=s[r],t=n.split("="),u[t[0]]=t[1];return u},exports.getUserInfo=getUserInfo,exports.getOAuthURL=getOAuthURL,exports.getTokens=getTokens,exports.createSignatureBaseString=createSignatureBaseString,exports.createSigningKey=createSigningKey,exports.createSignature=createSignature,exports.getAccessToken=getAccessToken,exports.postMessage=postMessage,exports.getTweets=getTweets,exports.getSignature=getSignature,exports.bodyToTokens=bodyToTokens;