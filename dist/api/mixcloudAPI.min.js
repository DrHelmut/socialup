var CLIENT_ID,CLIENT_SECRET,Q,REDIRECT_URI,fs,http,https,request;https=require("https"),http=require("http"),request=require("request"),Q=require("q"),fs=require("fs"),CLIENT_ID=process.env.MIXCLOUD_CLIENT_ID,CLIENT_SECRET=process.env.MIXCLOUD_CLIENT_SECRET,REDIRECT_URI=process.env.APP_URL+"/mixcloud2callback",exports.getOAuthURL=function(){return"https://www.mixcloud.com/oauth/authorize?client_id="+CLIENT_ID+"&redirect_uri="+REDIRECT_URI},exports.pushCode=function(e,t){var r,o,n;return r=Q.defer(),n={host:"www.mixcloud.com",port:443,path:"/oauth/access_token?client_id="+CLIENT_ID+"&redirect_uri="+REDIRECT_URI+"?state="+t+"&client_secret="+CLIENT_SECRET+"&code="+e,method:"GET"},o=https.request(n,function(e){var t;return t="",e.on("data",function(e){return t+=e}),e.on("end",function(){return r.resolve(JSON.parse(t))})}),o.on("error",function(e){return console.log("mixcloud authentication error: ",e),r.reject(e)}),o.end(),r.promise},exports.getUserInfo=function(e){var t,r,o;return t=Q.defer(),o={host:"api.mixcloud.com",path:"/me/?access_token="+e.access_token,method:"GET"},r=https.request(o,function(e){var r;return r="",e.on("data",function(e){return r+=e}),e.on("end",function(){var e;return e=JSON.parse(r),e.error?(console.log("mixcloud authentication error: ",e.error.message),t.reject(e.error)):t.resolve({userName:e.username})})}),r.on("error",function(e){return console.log("mixcloud authentication error: ",e),t.reject(e)}),r.end(),t.promise},exports.sendMusic=function(e,t,r){var o,n,c,s,i;if(n={mp3:fs.createReadStream(t.path),name:r.title,description:r.description},r.tags&&r.tags.length>0){for(c=s=0,i=r.tags.length-1;i>=0?i>=s:s>=i;c=i>=0?++s:--s)n["tags-"+c+"-tag"]=r.tags[c];return o=Q.defer(),request({method:"POST",uri:"https://api.mixcloud.com/upload/?access_token="+e.access_token,formData:n},function(e,t,r){var n;return e?o.reject(e):(n=JSON.parse(r),n.error?o.reject(n):o.resolve(n))}),o.promise}},exports.listMedia=function(e){var t,r,o;return t=Q.defer(),o={host:"api.mixcloud.com",path:"/me/cloudcasts/?access_token="+e.access_token,method:"GET"},r=https.request(o,function(e){var r;return r="",e.on("data",function(e){return r+=e}),e.on("end",function(){var e,o,n,c;return c=JSON.parse(r),c.error?(console.log("mixcloud listMedia error: ",c.error.message),t.reject(c.error)):(e={listener:0,playback:0,repost:0,like:0,comment:0},n=function(t){return{name:t,value:e[t]}},o=c.data.map(function(t){return e.listener+=t.listener_count,e.playback+=t.play_count,e.repost+=t.repost_count,e.like+=t.favorite_count,e.comment+=t.comment_count,{id:t.key,title:t.name,creationDate:t.created_time,streamURL:t.url,thumbnailURL:t.pictures.medium,description:t.description,counts:{listener:t.listener_count,playback:t.play_count,repost:t.repost_count,like:t.favorite_count,comment:t.comment_count}}}),t.resolve({list:o,stats:[n("listener"),n("playback"),n("repost"),n("like"),n("comment")]}))})}),r.on("error",function(e){return console.log("mixcloud listMedia error: ",e),t.reject(e)}),r.end(),t.promise};