var Q,TWITTER,app,bodyParser,cookieParser,emailService,error,eventsDAO,executeChainedEvent,executeChainedEvents,express,fs,getRefreshedToken,initiateUser,multer,postMediaLinkToProvider,postMediaLinkToProviders,postMessageToProvider,postMessageToProviders,providersAPI,providersCategories,publishFileToProvider,publishFileToProviders,scheduler,sendMusicToProvider,sendMusicToProviders,server,upload,userDAO,users;express=require("express"),multer=require("multer"),upload=multer({dest:"server/uploads/"}),fs=require("fs"),Q=require("q");try{require("../../localeConfig.js")}catch(error){console.warn("No configuration file found")}console.log("ENV ?",process.env.NODE_ENV),providersAPI=require("./providersAPI"),userDAO=require("./userDAO.js"),eventsDAO=require("./eventsDAO.js"),emailService=require("./emailService.js"),app=express(),TWITTER="twitter",users={},initiateUser=function(e){return console.log("initiate user with id: ",e),users[e]={id:e,providers:{}}},scheduler=require("./scheduler.js"),scheduler.addEventListerner("message",function(e,r,n,t,s){return postMessageToProviders(r,n,t,s).then(function(r){return eventsDAO.updateScheduledEventAfterExecution(e,r)},function(r){return eventsDAO.updateScheduledEventAfterError(e,r)})}),scheduler.addEventListerner("uploadVideo",function(e,r,n,t,s,o,i,u){var d;return d={title:o,description:i,tags:u,file:s},publishFileToProviders(r,n,t,s,d).then(function(r){return r&&r.length>0&&r[0].url&&(d.url=r[0].url),console.log("publishFileToProviders results: ",r),eventsDAO.updateScheduledEventAfterExecution(e,r),eventsDAO.retrieveChainedEvents(e)},function(r){return eventsDAO.updateScheduledEventAfterError(e,r)}).then(function(e){return executeChainedEvents(e,d)}).fin(function(){return fs.unlink(s.path)})}),getRefreshedToken=function(e,r){var n;return n=users[r].providers[e].tokens,"soundcloud"!==e&&n.expiry_date&&n.expiry_date<=Date.now()?(console.log("refresh oauth token for provider "+e),providersAPI[e].refreshTokens instanceof Function?("google"===e&&(n=users[r].providers[e].originalTokens),providersAPI[e].refreshTokens(n,r).then(function(n){return users[r].providers[e].tokens=n,userDAO.updateUserTokens(r,e,n),Q.fcall(function(){return n})})):Q.fcall(function(){throw new Error('no "refreshTokens" function for provider '+e)})):Q.fcall(function(){return n})},executeChainedEvents=function(e,r){var n,t,s,o,i;for(i=[],t=0,s=e.length;s>t;t++)n=e[t],console.log("execute chainedEvent: ",n),console.log("with results: ",i),o=null,"message"===n.eventType?o={url:r.url,title:r.title,description:r.description}:"uploadCloud"===n.eventType&&(o={file:r.file}),i.push(executeChainedEvent(n,o));return Q.all(i)},executeChainedEvent=function(e,r){var n;return console.log("executeChainedEvent: ",e),"message"===e.eventType?postMediaLinkToProviders(e.user,e.providers,e.eventParams[0],r.url,r.title,r.description,e.providersOptions):"uploadCloud"===e.eventType?(console.log("upload drive with params: ",r),n=e.providers[0],getRefreshedToken(n,e.user).then(function(t){return providersAPI[n].uploadDrive(t,r.file,e.eventParams[0])}).then(function(r){return console.log("eventsDAO.updateChainedEventAfterExecution"),eventsDAO.updateChainedEventAfterExecution(e._id,r)},function(r){return eventsDAO.updateChainedEventAfterError(e._id,r)})):void 0},userDAO.retrieveUsers().then(function(e){var r,n,t;for(console.log("retieved users: ",e),n=0,t=e.length;t>n;n++)r=e[n],users[e[r]._id]=e[r];return scheduler.loadScheduledEvents()}),app.set("port",process.env.PORT),app.use(express["static"]("public")),app.set("views",__dirname+"/public"),bodyParser=require("body-parser"),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),cookieParser=require("cookie-parser"),app.use(cookieParser()),app.get("/oauthURL/:provider/:userId",function(e,r){var n,t;return n=e.params.provider,t=e.params.userId,"twitter"===n?(providersAPI.twitter.getTokens(t).then(function(e){return void 0===users[t]&&initiateUser(t),users[t].providers[n]={userName:"",tokens:e},r.send(providersAPI.twitter.getOAuthURL()+"?oauth_token="+e.oauth_token)}),function(e){return console.log("error when computing twitter oauth url for user: ",e),r.send(e)}):void 0===providersAPI[n]?r.send("404"):r.send(providersAPI[n].getOAuthURL())}),app.get("/*2callback",function(e,r){var n,t,s,o,i,u,d;return i=e.path.split("2callback")[0].substr(1),n=e.query.code,d=e.query.state,t=null,void 0===users[d]&&initiateUser(d),i===TWITTER?(users[d].providers[TWITTER]||r.status(400).end("Error in twitter oauth process"),s=e.query.oauth_token,o=e.query.oauth_verifier,u=users[d].providers[TWITTER].tokens,u.oauth_token=s,void(t=function(){return providersAPI.twitter.getAccessToken(o,u)})):void(t=function(){return providersAPI[i].pushCode(n,d)})}),app.get("/events/:userId",function(e,r){var n;return n=e.params.userId,eventsDAO.retrieveScheduledEventsByUser(n).then(function(e){return r.send(e)}),function(e){return r.send(e)}}),app.get("/chainedEvents/:eventParentId",function(e,r){var n;return n=e.params.eventParentId,eventsDAO.retrieveChainedEvents(n).then(function(e){return r.send(e)}),function(e){return r.send(e)}}),app.get("/tracedEvents/:userId",function(e,r){var n;return n=e.params.userId,eventsDAO.retrieveTracedEventsByUser(n).then(function(e){return r.send(e)}),function(e){return r.send(e)}}),app.get("/event/:eventId",function(e,r){var n;return n=e.params.eventId,eventsDAO.retrieveScheduledEvent(n).then(function(e){return r.send(e)}),function(e){return r.send(e)}}),app.post("/event/:eventId",function(e,r){var n,t;return n=e.params.eventId,t=e.body,eventsDAO.updateScheduledEvent(n,t).then(result)(function(){return r.send(result)}),function(e){return r.send(e)}}),app.post("/event/chained/:provider/:eventId/:userId",function(e,r){var n,t,s,o;return n=e.params.eventId,o=e.params.userId,t=e.params.provider,s=e.body,eventsDAO.createChainedEvent(n,o,s.eventType,[t],void 0,s.eventParams.then(function(e){return r.send(e)})),function(e){return r.send(e)}}),app["delete"]("/event/:eventId",function(e,r){var n;return n=e.params.eventId,eventsDAO.deleteScheduledEvent(n).then(function(e){return r.status(1===e?200:400).end()}),function(e){return r.send(e)}}),app["delete"]("/event/chained/:eventId/:eventParentId",function(e,r){var n,t;return n=e.params.eventId,t=e.params.eventParentId,eventsDAO.deleteChainedEvent(n,t).then(function(e){return r.status(1===e?200:400).end()}),function(e){return r.send(e)}}),app["delete"]("/event/traced/:eventId",function(e,r){var n;return n=e.params.eventId,eventsDAO.deleteTracedEvent(n).then(function(e){return r.status(1===e?200:400).end()}),function(e){return r.send(e)}}),app["delete"]("/token/:provider/:userId",function(e,r){var n,t;return n=e.params.provider,t=e.params.userId,userDAO.deleteToken(n,t).then(function(e){return delete users[t].providers[n],r.status(1===e?200:400).end()}),function(e){return r.send(e)}}),app.get("/refreshToken/:provider/:userId",function(e,r){var n,t;return n=e.params.provider,t=e.params.userId,getRefreshedToken(n,t).then(function(e){return users[t].tokens[n]=e,userDAO.updateUserTokens(t,n,e),r.status(200).end()}),function(e){return r.send(e)}}),app.get("/user/:userId",function(e,r){var n;return n=e.params.userId,userDAO.retrieveUserById(n).then(function(e){return r.send(e)}),function(e){return r.send(e)}}),app.get("/cloudExplorer/:provider/:folderId/:userId",function(e,r){var n,t,s,o;return n=e.params.folderId,t=e.params.provider,o=e.params.userId,s=e.query.typeFilter,getRefreshedToken(t,o).then(function(e){return providersAPI[t].listFiles(e,n,s)}).then(function(e){return r.send(e)}).fail(function(e){return r.send(e)})}),app.get("/file/:provider/:fileId/:userId",function(e,r){var n,t,s;return n=e.params.fileId,t=e.params.provider,s=e.params.userId,getRefreshedToken(t,s).then(function(e){return providersAPI[t].downloadFile(e,n).pipe(r)}),function(e){return r.send(e)}}),app["delete"]("/file/:provider/:fileId/:userId",function(e,r){var n,t,s;return n=e.params.fileId,t=e.params.provider,s=e.params.userId,getRefreshedToken(t,s).then(function(e){return providersAPI[t].deleteFile(e,n)}).then(function(){return r.status(204).end()}).fail(function(e){return r.send(e)})}),app.get("/spaceUsage/:provider/:userId",function(e,r){var n,t;return n=e.params.provider,t=e.params.userId,getRefreshedToken(n,t).then(function(e){return providersAPI[n].getSpaceUsage(e)}).then(function(e){return r.send(e)}).fail(function(e){return r.send(e)})}),app.get("/searchPage/:provider/:pageName",function(e,r){var n,t,s;return t=e.params.provider,n=e.params.pageName,s=e.query.userId,s?getRefreshedToken(t,s).then(function(e){return providersAPI[t].searchPage(e,n)}).then(function(e){return r.send(e)}).fail(function(e){return r.send(e)}):providersAPI[t].searchPage(void 0,n).then(function(e){return r.send(e)}).fail(function(e){return r.send(e)})}),app.get("/pageMetrics/:provider/:metricType/:pageId",function(e,r){var n,t,s,o,i,u;return s=e.params.provider,n=e.params.metricType,t=e.params.pageId,o=e.query.since,i=e.query.until,u=e.query.userId,u?getRefreshedToken(s,u).then(function(e){return providersAPI[s].getPageMetrics(e,n,t,o,i)}).then(function(e){return r.send(e)}).fail(function(e){return r.send(e)}):providersAPI[s].getPageMetrics(void 0,n,t,o,i).then(function(e){return r.send(e)}).fail(function(e){return r.send(e)})}),app.post("/message/:userId",function(e,r){var n,t,s,o,i,u;return u=e.params.userId,s=e.body.providers,t=e.body.message,i=e.body.scheduledDate,n=e.body.eventParentId,o=e.body.providersOptions,n?(eventsDAO.createChainedEvent(n,u,"message",s,o,[t]).then(function(e){return r.send(e)}),function(e){return r.send("Cannot create or save chained event: "+e)}):void 0===i||new Date(i).getTime()<=Date.now()?(postMessageToProviders(u,s,o,t).then(function(e){return eventsDAO.createTracedEvent(u,"message",[t],s,s,e),r.send(e)}),function(e){return eventsDAO.createTracedEventError(u,"message",[t],s,s,e),r.send("Cannot send message err: "+e)}):(console.log("schedule event for ",i),scheduler.saveScheduledEvent(u,i,"message",s,o,[t]).then(function(e){return r.send(e)}),function(e){return r.send("Cannot create or save scheduled event: "+e)})}),postMessageToProviders=function(e,r,n,t){var s,o,i,u;for(u=[],s=0,o=r.length;o>s;s++)i=r[s],u.push(postMessageToProvider(e,i,n?n[i]:void 0,t));return Q.all(u)},postMessageToProvider=function(e,r,n,t){var s;return s=Q.defer(),(void 0===providersAPI[r]||void 0===providersAPI[r].postMessage)&&s.reject(new Error("unknow provider "+r+" or unsupported function postMessage")),getRefreshedToken(r,e).then(function(e){return providersAPI[r].postMessage(e,t,n)}).then(function(e){return e.provider=r,s.resolve(e)}).fail(function(e){return s.reject(e)}),s.promise},postMediaLinkToProviders=function(e,r,n,t,s,o,i){var u,d,a,p;for(p=[],console.log("postMediaLinkToProviders, messageProvidersOptions: ",i),u=0,d=r.length;d>u;u++)a=r[u],void 0!==i?p.push(postMediaLinkToProvider(e,a,n,t,s,o,i[a])):p.push(postMediaLinkToProvider(e,a,n,t,s,o));return Q.all(p)},postMediaLinkToProvider=function(e,r,n,t,s,o,i){var u;return console.log("postMediaLinkToProvider, messageProviderOptions: ",i),u=Q.defer(),(void 0===providersAPI[r]||void 0===providersAPI[r].postMediaLink)&&u.reject(new Error("unknow provider "+r+" or unsupported function postMessage")),getRefreshedToken(r,e).then(function(e){return providersAPI[r].postMediaLink(e,n,t,s,o,i)}).then(function(e){return u.resolve(e)}).fail(function(e){return u.reject(e)}),u.promise},app.post("/publishFromCloud/:userId",function(e,r){var n,t,s,o,i,u,d;return u=e.params.userId,o=e.body.providers,i=e.body.providersOptions,n=e.body.cloudProvider,t=e.body.fileId,s=e.body.fileName,d=null,getRefreshedToken(n,u).then(function(a){return d=fs.createWriteStream("./server/uploads/"+u+s),providersAPI[n].downloadFile(a,t).pipe(d),d.on("finish",function(){var t;return console.log("file downloaded "),t={title:e.body.title,description:e.body.description},e.body.tags&&(t.tags=e.body.tags,console.log("publishFileToProviders params: ",t)),console.log("providers: ",o),publishFileToProviders(u,o,i,{path:"./server/uploads/"+u+s},t).then(function(e){return fs.unlink("./server/uploads/"+u+s),eventsDAO.createTracedEvent(u,"publishFromCloud",[t.title,t.description,t.tags,n],o,i,e),r.send(e)}),function(e){return console.log(e),eventsDAO.createTracedEventError(u,"publishFromCloud",[t.title,t.description,t.tags,n],o,i,e),r.status(403).send(e)}}),d.on("error",function(e){return console.log(e),r.status(403).send(e)})})}),app.post("/uploadFileToCloud/:userId",upload.single("file"),function(e,r){var n,t;return n=e.body.provider,t=e.params.userId,getRefreshedToken(n,t).then(function(r){return providersAPI[n].uploadDrive(r,e.file,e.body.target)}).then(function(s){return eventsDAO.createTracedEvent(t,"uploadFileToCloud",[e.file.originalname],[n],void 0,s),r.send(s)}).fail(function(e){return r.status(403).send(e)})}),app.post("/uploadMusic/:userId",upload.single("file"),function(e,r){var n,t,s,o;return t=e.file.path,fs.renameSync(t,t+"_"+e.file.originalname),e.file.path=t+"_"+e.file.originalname,o=e.params.userId,s=e.body.providers.split(","),n={title:e.body.title,description:e.body.description},e.body.tags&&(n.tags=e.body.tags.split(",")),sendMusicToProviders(s,o,e.file,n).then(function(t){return fs.unlink(e.file.path),eventsDAO.createTracedEvent(o,"uploadMusic",n,s,void 0,t),r.send(t)}).fail(function(e){return console.log(e),eventsDAO.createTracedEventError(o,"uploadMusic",n,s,void 0,e),r.status(403).send(e)})}),sendMusicToProviders=function(e,r,n,t){var s,o,i,u;for(u=[],s=0,o=e.length;o>s;s++)i=e[s],u.push(sendMusicToProvider(i,r,n,t));return Q.all(u)},sendMusicToProvider=function(e,r,n,t){var s;return s=Q.defer(),getRefreshedToken(e,r).then(function(r){return console.log("sendMusic with provider: ",e),providersAPI[e].sendMusic(r,n,t)}).then(function(r){return r.provider=e,s.resolve(r)},function(e){return s.reject(e)}),s.promise},app.post("/uploadFile/:userId",upload.single("file"),function(e,r){var n,t,s,o,i,u;return t=e.file.path,fs.renameSync(t,t+"_"+e.file.originalname),e.file.path=t+"_"+e.file.originalname,u=e.params.userId,i=e.body.scheduledDate,s=e.body.providers.split(","),o=JSON.parse(e.body.selectedProvidersOptions),console.log("scheduledDate? ",i),console.log("selectedProvidersOptions? ",o),n={title:e.body.title,description:e.body.description},e.body.tags&&(n.tags=e.body.tags.split(",")),void 0===i||new Date(i).getTime()<=Date.now()?publishFileToProviders(u,s,o,e.file,n).then(function(t){return console.log("uploadFile OK"),fs.unlink(e.file.path),eventsDAO.createTracedEvent(u,"uploadVideo",n,s,o,t),r.send(t)},function(e){return console.error("error in uploadFile: ",e),eventsDAO.createTracedEventError(u,"uploadVideo",n,s,o,e),r.status(403).send(e)}):scheduler.saveScheduledEvent(u,i,"uploadVideo",s,o,[e.file,n.title,n.description,n.tags].then(function(e){return r.send(e)},function(e){return console.log("err dans save Scheduled Event: ",e),r.send("Cannot create or save scheduled event: "+e)}))}),publishFileToProviders=function(e,r,n,t,s){var o,i,u,d;for(d=[],o=0,i=r.length;i>o;o++)u=r[o],d.push(publishFileToProvider(e,u,n[u],t,s));return Q.all(d)},publishFileToProvider=function(e,r,n,t,s){var o;return o=Q.defer(),getRefreshedToken(r,e).then(function(o){return providersAPI[r].sendVideo(o,t,e,s,n)}).then(function(e){return e.provider=r,o.resolve(e)},function(e){return o.reject(e)}),o.promise},app.get("/calendars/:provider/:userId",function(e,r){var n,t;return t=e.params.userId,n=e.params.provider,getRefreshedToken(n,t).then(function(e){return providersAPI[n].getUserCalendars(e)}).then(function(e){return r.send(e)}).fail(function(e){return r.status(404).send(e)})}),app.get("/socialEvents/:provider/:userId",function(e,r){var n,t,s,o,i;return i=e.params.userId,t=e.params.provider,s=e.query.since,o=e.query.until,n=e.query.calendarId,getRefreshedToken(t,i).then(function(e){return providersAPI[t].getUserEvents(e,s,o,n)}).then(function(e){return r.send(e)}).fail(function(e){return r.status(404).send(e)})}),app.get("/facebookGroups/:userId",function(e,r){var n;return n=e.params.userId,getRefreshedToken("facebook",n).then(function(e){return providersAPI.facebook.getUserGroups(e)}).then(function(e){return r.send(e)}).fail(function(e){return r.status(404).send(e)})}),app.get("/facebookPages/:userId",function(e,r){var n;return n=e.params.userId,providersAPI.facebook.getPages(users[n].providers.facebook.tokens).then(function(e){return r.send(e)},function(e){return r.status(404).send(e)})}),providersCategories={},app.get("/categories/:provider/:userId",function(e,r){var n,t;return n=e.params.provider,t=e.params.userId,void 0!==providersCategories[n]?r.send(providersCategories[n]):getRefreshedToken(n,t).then(function(e){return providersAPI[n].listCategories(e,t)}).then(function(e){return providersCategories[n]=e,r.send(e)}).fail(function(e){return r.status(403).send(e)})}),app.get("/search/video/:provider",function(e,r){var n,t,s,o,i;return o=e.params.provider,i=e.query.videoName,s=e.query.order,t=e.query.next,n=e.query.limit,!n||parseInt(n)<10||parseInt(n)>50?r.status(422).send("limit field not properly set (must be >= 10 and <=50)"):providersAPI[o].searchVideo(i,n,s,t).then(function(e){return r.send(e)}).fail(function(e){return r.status(403).send(e)})}),app.get("/media/:provider/:userId",function(e,r){var n,t;return n=e.params.provider,t=e.params.userId,getRefreshedToken(n,t).then(function(e){return providersAPI[n].listMedia(e,t,users[t].providers[n].userName)}).then(function(e){return r.send(e)}).fail(function(e){return r.status(403).send(e)})}),app.get("/authenticate",function(e,r){var n,t;return n=e.query.login,t=e.query.password,void 0!==n&&void 0!==t?userDAO.authenticate(n,t).then(function(e){return r.send(e)},function(e){return console.log(e),r.status(403).end()}):(console.log("social auth not yet implemented"),r.status(404).end())}),app.post("/user/create",function(e,r){var n,t,s,o,i;return n=e.body.firstName,t=e.body.lastName,s=e.body.login,o=e.body.password,void 0!==s&&void 0!==o&&void 0!==n&&void 0!==t?(i={firstName:n,lastName:t,login:s,password:o,providers:{}},userDAO.saveUser(i).then(function(e){return r.send(e)},function(e){return console.log(e),r.status(404).end()})):(console.log("social user registration not yet implemented"),r.status(404).end())}),app.post("/user/resetPassword/:userEmail",function(e,r){var n;return n=e.params.userEmail,emailService.sendMail("reset",n).then(function(e){return r.send(e)},function(e){return console.log(e),r.status(404).end()})}),server=app.listen(app.get("port"),function(){return console.log("Express server started on port %s",server.address().port)});