var DAILYMOTION_API_KEY,DAILYMOTION_API_SECRET,DAILYMOTION_REDIRECT_URL,DESCRIPTION_MAX_LENGTH,Promise,checkAccessTokenValidity,fs,getUploadURL,http,https,processGetRequest,processOrder,publishVideo,querystring,refreshTokens,request,saveTokensForUser,userDAO;https=require("https"),http=require("http"),request=require("request"),Promise=require("bluebird"),fs=require("fs"),querystring=require("querystring"),userDAO=require("../userDAO"),DAILYMOTION_API_KEY=process.env.DAILYMOTION_API_KEY,DAILYMOTION_API_SECRET=process.env.DAILYMOTION_API_SECRET,DAILYMOTION_REDIRECT_URL=process.env.APP_URL+"/dailymotion2callback",DESCRIPTION_MAX_LENGTH=800,exports.getOAuthURL=function(){return"https://www.dailymotion.com/oauth/authorize?response_type=code&client_id="+DAILYMOTION_API_KEY+"&redirect_uri="+DAILYMOTION_REDIRECT_URL+"&scope=userinfo+email+manage_videos+manage_playlists"},exports.pushCode=function(e,t){var r,n,o,s;return r=Promise.pending(),n=querystring.stringify({grant_type:"authorization_code",client_id:DAILYMOTION_API_KEY,client_secret:DAILYMOTION_API_SECRET,redirect_uri:DAILYMOTION_REDIRECT_URL,code:e}),o={host:"api.dailymotion.com",port:443,path:"/oauth/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":n.length}},s=https.request(o,function(e){return e.setEncoding("utf8"),e.on("data",function(e){var n;return n=JSON.parse(e),r.resolve(saveTokensForUser(n,t))})}),s.on("error",function(e){return r.reject(new Error(e))}),s.write(n),s.end(),r.promise},saveTokensForUser=function(e,t){return e.expiry_date=Date.now()+e.expires_in,delete e.expires_in,e},checkAccessTokenValidity=function(e,t){var r;return r=Promise.pending(),e.expiry_date<=Date.now()?(console.log("refresh dailymotion oauth token "),refreshTokens(e,t)):(r.resolve(e),r.promise)},refreshTokens=function(e,t){var r,n,o,s;return r=Promise.pending(),n=querystring.stringify({grant_type:"refresh_token",client_id:DAILYMOTION_API_KEY,client_secret:DAILYMOTION_API_SECRET,refresh_token:e.refresh_token}),o={host:"api.dailymotion.com",port:443,path:"/oauth/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":n.length}},s=https.request(o,function(n){return n.setEncoding("utf8"),n.on("data",function(n){return e=JSON.parse(n),r.resolve(saveTokensForUser(e,t))})}),s.on("error",function(e){return r.reject(new Error(e))}),s.write(n),s.end(),r.promise},exports.listMedia=function(e){return processGetRequest(e.access_token,"/user/me/videos?fields=id,thumbnail_60_url,title,description,status,created_time,views_total,comments_total",function(e){var t,r,n;return t={view:0,comment:0},r=function(e){return{name:e,value:t[e]}},n=e.list.map(function(e){return e.thumbnailURL=e.thumbnail_60_url,e.creationDate=new Date(1e3*e.created_time),delete e.thumbnail_60_url,delete e.created_time,t.view+=e.views_total,t.comment+=e.comments_total,e.counts={view:e.views_total,comment:e.comments_total},delete e.views_total,delete e.comments_total,e}),{list:n,stats:[r("view"),r("comment")]}})},exports.searchVideo=function(e,t,r,n){var o,s,i,a;return i=null,o="id,thumbnail_120_url,title,description,status,created_time,views_total,comments_total,owner.username,duration",s=processOrder(r),a="/videos?fields="+o+"&search="+encodeURI(e)+"&limit="+t,null!=s&&(a+="&sort="+s),null!=n&&(a+="&page="+n),processGetRequest(i,a,function(e){return{videos:e.list.map(function(e){return null!=e.description&&e.description.length>DESCRIPTION_MAX_LENGTH&&(e.description=e.description.substr(0,DESCRIPTION_MAX_LENGTH)+" ..."),e.thumbnailURL=e.thumbnail_120_url,e.creationDate=new Date(1e3*e.created_time),e.counts={view:e.views_total,comment:e.comments_total},e.channel=e["owner.username"],e.channelURL="http://www.dailymotion.com/"+e["owner.username"],delete e["owner.username"],delete e.views_total,delete e.comments_total,delete e.thumbnail_120_url,delete e.created_time,e}),totalResults:e.total,has_more:e.has_more,page:e.page}})},processOrder=function(e){switch(e){case"date":return"recent";case"rating":return"trending";case"relevance":return"relevance";case"viewCount":return"visited";default:return}},exports.sendVideo=function(e,t,r,n,o){var s;return s=Promise.pending(),getUploadURL(e).then(function(r){return request({method:"POST",uri:r.upload_url,auth:{bearer:e.access_token},formData:{file:fs.createReadStream(t.path)}},function(t,r,i){var a;return null!=t?s.reject(t):(a=JSON.parse(i).url,publishVideo(a,e,n,o,s))})},function(e){return s.reject(e)}),s.promise},publishVideo=function(e,t,r,n,o){return request({method:"POST",uri:"https://api.dailymotion.com/me/videos",auth:{bearer:t.access_token},form:{url:e,title:r.title,channel:n.channel.id,description:r.description,tags:r.tags,published:!0,"private":null!=n["private"]?n["private"]:!1}},function(e,t,r){var n;return null!=e?(console.log("cannot publish the video. Err: ",e),o.reject(new Error(e))):(n=JSON.parse(r),null!=n.error?o.reject(new Error(n.error.message)):o.resolve({url:"http://www.dailymotion.com/video/"+n.id+"_"+n.title+"_"+n.channel,thumbnail:"http://www.dailymotion.com/thumbnail/video/"+n.id}))})},getUploadURL=function(e){return processGetRequest(e.access_token,"/file/upload")},exports.getUserInfo=function(e){return processGetRequest(e.access_token,"/user/me?fields=id,screenname,email",function(e){return{userName:e.screename}})},exports.listCategories=function(e,t){var r;return r=Promise.pending(),checkAccessTokenValidity(e,t).then(function(e){return r.resolve(processGetRequest(e.access_token,"/channels",function(e){return e.list.map(function(e){return e.description,e})}))},function(e){return r.reject(e)}),r.promise},processGetRequest=function(e,t,r){var n,o,s;return n=Promise.pending(),s={host:"api.dailymotion.com",port:443,path:t,method:"GET"},null!=e&&(s.headers={Authorization:"Bearer "+e}),o=https.request(s,function(e){var t;return t="",e.on("data",function(e){return t+=e}),e.on("end",function(){return null!=r?n.resolve(r(JSON.parse(t))):n.resolve(JSON.parse(t))})}),o.on("error",function(e){return n.reject(e)}),o.end(),n.promise},exports.refreshTokens=refreshTokens;