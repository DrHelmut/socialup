var CLIENT_ID,CLIENT_SECRET,DESCRIPTION_MAX_LENGTH,Q,REDIRECT_URL,finalizeUpload,fs,generateUploadTicket,getUnauthenticatedToken,https,patchMetadata,processGetRequest,processOrder,publishVideo,request,unauthenticatedToken,verifyUpload;Q=require("q"),request=require("request"),https=require("https"),fs=require("fs"),CLIENT_ID=process.env.VIMEO_CLIENT_ID,CLIENT_SECRET=process.env.VIMEO_CLIENT_SECRET,REDIRECT_URL=process.env.APP_URL+"/vimeo2callback",DESCRIPTION_MAX_LENGTH=1250,unauthenticatedToken=null,exports.getOAuthURL=function(){return NaN+encodeURI("public private purchased create edit delete upload interact")},exports.pushCode=function(e,t){var r;return r=Q.defer(),request({method:"POST",uri:"https://api.vimeo.com/oauth/access_token",auth:{user:CLIENT_ID,pass:CLIENT_SECRET},form:{grant_type:"authorization_code",redirect_uri:REDIRECT_URL,code:e}},function(e,t,o){var n;return e?(console.log("Err: ",e),r.reject(e)):(n=JSON.parse(o),n.error?r.reject(n):r.resolve(n))}),r.promise},getUnauthenticatedToken=function(){var e;return e=Q.defer(),request({method:"POST",uri:"https://api.vimeo.com/oauth/authorize/client",auth:{user:CLIENT_ID,pass:CLIENT_SECRET},form:{grant_type:"client_credentials",redirect_uri:REDIRECT_URL}},function(t,r,o){var n;return t?(console.log("Err: ",t),e.reject(t)):(n=JSON.parse(o),console.log("UnauthenticatedToken ?",n),n.error?e.reject(n):(unauthenticatedToken=n,e.resolve(n)))}),e.promise},exports.getUserInfo=function(e){var t,r;return t=Q.defer(),r={userName:e.user.name},delete e.user,t.resolve(r),t.promise},exports.listMedia=function(e){return processGetRequest(e.access_token,"/me/videos",function(e){var t,r,o;return t={view:0,comment:0,like:0},r=function(e){return{name:e,value:t[e]}},o={list:e.data.map(function(e){return e.id=e.uri.substr(e.uri.lastIndexOf("/")+1),e.title=e.name,e.thumbnailURL=e.pictures.sizes[0].link,e.creationDate=e.created_time,t.view+=e.stats.plays,t.comment+=e.metadata.connections.comments.total,t.like+=e.metadata.connections.likes.total,e.counts={view:e.stats.plays,comment:e.metadata.connections.comments.total,like:e.metadata.connections.likes.total},delete e.stats,delete e.metadata.connections,e}),stats:[r("view"),r("comment"),r("like")]}})},exports.searchVideo=function(e,t,r,o){var n,a;return a="/videos?query="+encodeURI(e)+"&per_page="+t,o&&(a+="&page="+o),n=processOrder(r),a+="&sort="+n,processGetRequest(unauthenticatedToken.access_token,a,function(e){var t;return t={videos:e.data.map(function(e){var t;return t={},t.id=e.uri.substr(e.uri.lastIndexOf("/")+1),t.title=e.name,t.thumbnailURL=e.pictures.sizes[0].link,t.creationDate=e.created_time,e.description&&e.description.length>DESCRIPTION_MAX_LENGTH?t.description=e.description.substr(0,DESCRIPTION_MAX_LENGTH):t.description=e.description,t.duration=e.duration,t.channel=e.user.name,t.channelURL=e.user.link,t.counts={view:e.stats.plays,comment:e.metadata.connections.comments.total,like:e.metadata.connections.likes.total},t}),totalResults:e.total,next:e.next,previous:e.previous,first:e.first,last:e.last,page:e.page}})},processOrder=function(e){switch(e){case"date":return"date";case"rating":return"likes";case"relevance":return"relevant";case"viewCount":return"plays";default:return}},exports.sendVideo=function(e,t,r,o,n){var a,s,i,c;return s=Q.defer(),i=null,a=null,c=null,generateUploadTicket(e).then(function(r){return console.log("upload to "+r.upload_link_secure),i=r.upload_link_secure,a=r.complete_uri,publishVideo(r.upload_link_secure,e,t)}).then(function(){return verifyUpload(i,e)}).then(function(){return finalizeUpload(a,e)}).then(function(t){return c=t,console.log("finalizeUpload videoId: ",c),patchMetadata(e,c,o.title,o.description,n)}).then(function(){return s.resolve({url:"https://vimeo.com/"+c})}).fail(function(e){return s.reject(e)}),s.promise},generateUploadTicket=function(e){var t;return t=Q.defer(),request({method:"POST",uri:"https://api.vimeo.com/me/videos",auth:{bearer:e.access_token},form:{type:"streaming"}},function(e,r,o){var n;return e?t.reject(e):(n=JSON.parse(o),n.error?t.reject(n):t.resolve(n))}),t.promise},publishVideo=function(e,t,r){var o,n;return o=Q.defer(),n=fs.statSync(r.path),request({method:"PUT",uri:e,auth:{bearer:t.access_token},headers:{"Content-Length":n.size,"Content-Type":"video/mp4"},body:fs.readFileSync(r.path)},function(e,t,r){var n;return e?(console.log("cannot publish the video. Err: ",e),o.reject(e)):(n=JSON.parse(r),console.log("publishVideo statusCode ?",t.statusCode),r.error?o.reject(r.error):o.resolve(r))}),o.promise},verifyUpload=function(e,t){var r;return r=Q.defer(),request({method:"PUT",uri:e,auth:{bearer:t.access_token},headers:{"Content-Range":"bytes */*"}},function(e,t,o){return e?(console.log("cannot verifyUpload. Err: ",e),r.reject(e)):(console.log("verifyUpload statusCode ?",t.statusCode),console.log("headers range: ",t.headers.range),o.error?r.reject(o.error):r.resolve(o))}),r.promise},finalizeUpload=function(e,t){var r;return console.log("completeURI? ",e),r=Q.defer(),request({method:"DELETE",uri:"https://api.vimeo.com"+e,auth:{bearer:t.access_token}},function(e,t,o){var n;return e?(console.log("cannot finalizeUpload. Err: ",e),r.reject(e)):201!==t.statusCode?r.reject(o.error):(n=t.headers.location,r.resolve(n.substr(n.lastIndexOf("/")+1)))}),r.promise},patchMetadata=function(e,t,r,o,n){var a;return console.log("vimeo patchMetadata providerOptions",n),a=Q.defer(),request({method:"PATCH",json:!0,uri:"https://api.vimeo.com/videos/"+t,auth:{bearer:e.access_token},body:{name:r,description:o,privacy:{view:n.privacyStatus}}},function(e,t,r){return e?(console.log("cannot patchMetadata. Err: ",e),a.reject(e)):(console.log("patchMetadata statusCode ?",t.statusCode),r.error?a.reject(r.error):a.resolve())}),a.promise},processGetRequest=function(e,t,r){var o,n,a;return o=Q.defer(),a={host:"api.vimeo.com",port:443,path:t,method:"GET",headers:{Authorization:"Bearer "+e}},n=https.request(a,function(e){var t;return t="",e.on("data",function(e){return t+=e}),e.on("end",function(){return o.resolve(r(JSON.parse(t)))})}),n.on("error",function(e){return o.reject(e)}),n.end(),o.promise},getUnauthenticatedToken();