var API_KEY,FOLDER_MIME_TYPE,GOOGLE_API_ID,GOOGLE_API_SECRET,GOOGLE_REDIRECT_URL,OAuth2,Q,calendar,drive,fs,googleAPI,googlePlus,moment,oauth2Client,userDAO,youtubeAPI;googleAPI=require("googleapis"),Q=require("q"),fs=require("fs"),userDAO=require("../userDAO"),moment=require("moment"),GOOGLE_API_ID=process.env.GOOGLE_API_ID,GOOGLE_API_SECRET=process.env.GOOGLE_API_SECRET,GOOGLE_REDIRECT_URL=process.env.APP_URL+"/google2callback",API_KEY=process.env.GOOGLE_API_KEY,FOLDER_MIME_TYPE="application/vnd.google-apps.folder",OAuth2=googleAPI.auth.OAuth2,oauth2Client=new OAuth2(GOOGLE_API_ID,GOOGLE_API_SECRET,GOOGLE_REDIRECT_URL),youtubeAPI=googleAPI.youtube({version:"v3",auth:oauth2Client}),drive=googleAPI.drive({version:"v2",auth:oauth2Client}),googlePlus=googleAPI.plus({version:"v1",auth:oauth2Client}),calendar=googleAPI.calendar({version:"v3",auth:oauth2Client}),exports.getOAuthURL=function(){var e,t;return e=["https://www.googleapis.com/auth/youtube.upload","https://www.googleapis.com/auth/youtube","https://www.googleapis.com/auth/youtubepartner","https://www.googleapis.com/auth/youtube.force-ssl","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/plus.stream.write","https://www.googleapis.com/auth/calendar"],t=oauth2Client.generateAuthUrl({access_type:"offline",scope:e})},exports.pushCode=function(e){var t;return t=Q.defer(),oauth2Client.getToken(e,function(e,r){return e?(console.log("unable to set credentials, err: ",e),t.reject(e)):(oauth2Client.setCredentials(r),t.resolve(r))}),t.promise},exports.refreshTokens=function(e,t){var r,n;return n=Q.defer(),r={access_token:e.access_token},null!=e.refresh_token&&(r.refresh_token=e.refresh_token),oauth2Client.setCredentials(r),oauth2Client.refreshAccessToken(function(e,t){return e||(oauth2Client.setCredentials(t),n.resolve(okens)),console.log("unable to refresh credentials, err: ",e),n.reject(e)}),n.promise},exports.listCategories=function(e){var t;return oauth2Client.setCredentials(e),t=Q.defer(),youtubeAPI.videoCategories.list({part:"snippet",regionCode:"fr",hl:"fr_FR"},function(e,r){var n,o,i,s,a;if(null!=e)return t.reject(e);for(n=[],a=r.items,i=0,s=a.length;s>i;i++)o=a[i],o.snippet.assignable&&n.push({id:o.id,name:o.snippet.title});return t.resolve(n)}),t.promise},exports.listMedia=function(e,t){var r,n;return oauth2Client.setCredentials(e),r=Q.defer(),n=[],youtubeAPI.search.list({part:"snippet",forMine:!0,type:"video"},function(e,t){var o,i,s,a,l,u,c;if(null!=e)return r.reject(e);for(c=[],o={view:0,like:0,dislike:0,favorite:0,comment:0},i=function(e){return{name:e,value:o[e]}},u=t.items,a=0,l=u.length;l>a;a++)s=u[a],n.push(s.id.videoId),c.push({id:s.id.videoId,creationDate:s.snippet.publishedAt,title:s.snippet.title,description:s.snippet.description,thumbnailURL:s.snippet.thumbnails["default"].url});return youtubeAPI.videos.list({part:"statistics",id:n.toString()},function(e,t){var n,a,l,u;for(n=0,u=t.items,a=0,l=u.length;l>a;a++)s=u[a],c[n].counts=s.statistics,o.view+=parseInt(s.statistics.viewCount),o.like+=parseInt(s.statistics.likeCount),o.dislike+=parseInt(s.statistics.dislikeCount),o.favorite+=parseInt(s.statistics.favoriteCount),o.comment+=parseInt(s.statistics.commentCount),n++;return r.resolve({list:c,stats:[i("view"),i("like"),i("dislike"),i("favorite"),i("comment")]})})}),r.promise},exports.searchPage=function(e,t){var r,n;return r=Q.defer(),n={auth:API_KEY,part:"snippet",q:t,type:"channel",safeSearch:"none"},youtubeAPI.search.list(n,function(e,t){var n,o,i,s,a;if(null!=e)return r.reject(e);for(n={},a=t.items,i=0,s=a.length;s>i;i++)o=a[i],n[o.id.channelId]={id:o.id.channelId,creationDate:o.snippet.publishedAt,name:o.snippet.channelTitle,displayName:o.snippet.title,description:o.snippet.description,thumbnailURL:o.snippet.thumbnails["default"].url};return youtubeAPI.channels.list({auth:API_KEY,part:"statistics",id:Object.keys(n).toString()},function(e,t){var i,s,a;if(t)for(a=t.items,i=0,s=a.length;s>i;i++)o=a[i],n[o.id].counts={view:parseInt(o.statistics.viewCount),subscriber:parseInt(o.statistics.subscriberCount),video:parseInt(o.statistics.videoCount),comment:parseInt(o.statistics.commentCount)};return r.resolve(Object.keys(n).map(function(e){return n[e]}))})}),r.promise},exports.searchVideo=function(e,t,r,n){var o,i,s,a,l,u,c;return i=Q.defer(),c={},o=[],l={auth:API_KEY,part:"snippet",q:e,type:"video",maxResults:t,safeSearch:"none"},null!=r&&(l.order=r),null!=n&&(l.pageToken=n),u=null,s=null,a=null,youtubeAPI.search.list(l,function(e,t){var r,n,l,d;if(null!=e)i.reject(e);else for(u=t.pageInfo.totalResults,s=t.nextPageToken,a=t.prevPageToken,c=[],d=t.items,n=0,l=d.length;l>n;n++)r=d[n],c[r.id.videoId]={id:r.id.videoId,channelId:r.snippet.channelId,channelURL:"https://www.youtube.com/channel/"+r.snippet.channelId,creationDate:r.snippet.publishedAt,title:r.snippet.title,description:r.snippet.description,thumbnailURL:r.snippet.thumbnails["default"].url},-1===o.indexOf(r.snippet.channelId)&&o.push(r.snippet.channelId);return youtubeAPI.videos.list({auth:API_KEY,part:"statistics,contentDetails",id:Object.keys(c).toString()},function(e,t){var n,l,d;if(e)return console.error(e),i.reject(e);if(t)for(d=t.items,n=0,l=d.length;l>n;n++)r=d[n],c[r.id].duration=moment.duration(r.contentDetails.duration).asSeconds(),c[r.id].counts={view:parseInt(r.statistics.viewCount),like:parseInt(r.statistics.likeCount),dislike:parseInt(r.statistics.dislikeCount),favorite:parseInt(r.statistics.favoriteCount),comment:parseInt(r.statistics.commentCount)};return youtubeAPI.channels.list({auth:API_KEY,part:"snippet",id:o.toString()},function(e,t){var r,n,o,l,d,p;if(null!=e)console.error(e),i.reject(e);else{for(n={},d=t.items,o=0,l=d.length;l>o;o++)r=d[o],n[r.id]=r.snippet.title;p=Object.keys(c).map(function(e){return c[e].channel=n[c[e].channelId],delete c[e].channelId,c[e]})}return i.resolve({videos:p,totalResults:u,nextPageToken:s,prevPageToken:a})})})}),i.promise},exports.sendVideo=function(e,t,r,n,o){var i,s,a,l,u;return s=Q.defer(),oauth2Client.setCredentials(e),a={snippet:{title:n.title,description:n.description,tags:n.tags,categoryId:o.category.id},status:{privacyStatus:o.privacyStatus}},i=fs.readFileSync(t.path),void 0===i&&s.reject(new Error("cannot load file from path: "+t.path)),l={part:Object.keys(a).join(","),media:{mimeType:t.mimetype,body:i},resource:a},u=youtubeAPI.videos.insert(l),u.on("complete",function(e){var t;try{return t=JSON.parse(e.body),null!=t.error?s.reject(t.error):s.resolve({url:"https://www.youtube.com/watch?v="+t.id,thumbnail:t.snippet.thumbnails.high.url})}catch(r){return s.reject(error)}}),u.on("error",function(e){return s.reject(new Error(e))}),s.promise},exports.uploadDrive=function(e,t,r){var n,o,i,s,a;return o=Q.defer(),oauth2Client.setCredentials(e),i={uploadType:"media",visibility:"PRIVATE",title:t.originalname},void 0!==r&&(i.parents=[{id:r}]),n=fs.readFileSync(t.path),void 0===n&&o.reject(new Error("cannot load file from path: "+t.path)),s={part:Object.keys(i).join(","),media:{mimeType:t.mimetype,body:n,title:t.originalname},resource:i},a=drive.files.insert(s),a.on("complete",function(e){var t;try{return t=JSON.parse(e.body),o.resolve({url:"https://drive.google.com/file/d/"+t.id+"/view",downloadUrl:t.downloadUrl})}catch(r){return o.reject(error)}}),a.on("error",function(e){return console.log("video upload request failed: ",e),o.reject(new Error(e))}),o.promise},exports.listFiles=function(e,t,r){var n,o;return n=Q.defer(),o="trashed=false",void 0===t&&(t="root"),o+=' and "'+t+'" in parents',null!=r&&(o+="folder"===r?' and mimeType="application/vnd.google-apps.folder" ':' and (mimeType="application/vnd.google-apps.folder" or mimeType contains "'+r+'/") '),oauth2Client.setCredentials(e),drive.files.list({folderId:t,q:o},function(e,t){var r;return null!=e?(console.log("The API returned an error: "+e),void n.reject(new Error(e))):(r=t.items,0===r.length?n.resolve():n.resolve(r.map(function(e){var t;return t={name:e.title,id:e.id,mimeType:e.mimeType,isFolder:e.mimeType===FOLDER_MIME_TYPE},null!=e.downloadUrl&&(t.downloadUrl=e.downloadUrl.replace("&gd=true","")),t})))}),n.promise},exports.getUserInfo=function(e){var t;return oauth2Client.setCredentials(e),t=Q.defer(),googlePlus.people.get({userId:"me"},function(e,r){return null!=e?(console.log("getUserInfo error: ",e),t.reject(new Error(e))):t.resolve({userName:r.displayName})}),t.promise},exports.downloadFile=function(e,t){return oauth2Client.setCredentials(e),drive.files.get({fileId:t+"?alt=media"},function(e){return null!=e?console.log("cannot get data for fileId: "+t+" error: ",e):void 0})},exports.checkFileData=function(e,t){var r;return r=Q.defer(),drive.files.get({fileId:t},function(e,n){var o;return e?(console.log("cannot get data for fileId: "+t+" error: ",e),r.reject(e)):(o={name:n.title,id:t,mimeType:n.mimeType,isFolder:n.mimeType===FOLDER_MIME_TYPE},n.downloadUrl&&(o.downloadUrl=n.downloadUrl.replace("&gd=true","")),r.resolve(o))}),r.promise},exports.getSpaceUsage=function(e){var t;return oauth2Client.setCredentials(e),t=Q.defer(),drive.about.get(function(e,r){return e?(console.log("cannot get googleDrive SpaceUsage, error: ",e),t.reject(e)):t.resolve({used:parseInt(r.quotaBytesUsedAggregate),total:parseInt(r.quotaBytesTotal)})}),t.promise},exports.createShareLink=function(e,t){var r,n;return oauth2Client.setCredentials(e),r=Q.defer(),n={type:"anyone",id:"anyone",name:"anyone",role:"reader",withLink:!0},drive.permissions.insert({fileId:t,resource:n},function(e,t){return null!=e?(console.log("cannot change file permission ",e),r.reject(e)):r.resolve(t)}),r.promise},exports.deleteFile=function(e,t){var r;return oauth2Client.setCredentials(e),r=Q.defer(),drive.files["delete"]({fileId:t},function(e,t){return e?(console.log("cannot delete file ",e),r.reject(e)):r.resolve(t)}),r.promise},exports.getUserCalendars=function(e){var t;return oauth2Client.setCredentials(e),t=Q.defer(),calendar.calendarList.list({},function(e,r){return e&&(console.error("err: ",e),t.reject(e)),t.resolve(r.items.map(function(e){return{accessRole:e.accessRole,id:e.id,backgroundColor:e.backgroundColor,foregroundColor:e.foregroundColor,name:e.summary,selected:e.selected,description:e.description}}))}),t.promise},exports.getUserEvents=function(e,t,r,n){var o,i,s;return o=Q.defer(),s=moment(parseInt(t)).toISOString(),i=moment(parseInt(r)).toISOString(),oauth2Client.setCredentials(e),calendar.events.list({calendarId:encodeURIComponent(n),showHiddenInvitations:!0,timeMin:s,timeMax:i,singleEvents:!0,orderBy:"startTime"},function(e,t){var r,i,s,a,l;if(e)return console.error("calendarId: "+n(NaN,e)),o.reject(e);for(l=[],i=t.items,s=0,a=i.length;a>s;s++)r=i[s],l.push({id:r.id,name:r.summary,start_time:r.start.dateTime,end_time:r.end.dateTime,description:r.description,rsvp_status:r.status,start:r.start.date,creator:r.creator,htmlLink:r.htmlLink,location:r.location});return o.resolve(l)}),o.promise};