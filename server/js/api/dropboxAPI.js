var DROPBOX_APP_KEY,DROPBOX_APP_SECRET,DROPBOX_REDIRECT_URI,END_POINT,Promise,fs,getUserInfo,https,processGetRequest,querystring,request,retrieveAllFiles;DROPBOX_APP_KEY=process.env.DROPBOX_APP_KEY,DROPBOX_APP_SECRET=process.env.DROPBOX_APP_SECRET,DROPBOX_REDIRECT_URI=process.env.APP_URL+"/dropbox2callback",END_POINT="api.dropboxapi.com",https=require("https"),Promise=require("bluebird"),request=require("request"),fs=require("fs"),querystring=require("querystring"),exports.pushCode=function(e){var r,t,o,n;return r=Promise.pending(),t=querystring.stringify({client_id:DROPBOX_APP_KEY,client_secret:DROPBOX_APP_SECRET,redirect_uri:DROPBOX_REDIRECT_URI,grant_type:"authorization_code",code:e}),o={host:END_POINT,port:443,path:"/1/oauth2/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":t.length}},n=https.request(o,function(e){return e.setEncoding("utf8"),e.on("data",function(e){return r.resolve(JSON.parse(e))})}),n.on("error",function(e){return r.reject(new Error(e))}),n.write(t),n.end(),r.promise},exports.listFiles=function(e,r,t){return r=void 0===r||"root"===r?"":decodeURI(r),retrieveAllFiles(e,r,t)},retrieveAllFiles=function(e,r,t){var o,n;return o=Promise.pending(),n={path:r,recursive:!1,include_media_info:!1},request({uri:"https://"+END_POINT+"/2/files/list_folder",auth:{bearer:e.access_token},method:"POST",json:!0,body:n},function(e,r,n){var s,i,a,u,p;if(null!=e)return o.reject(e);for(p=[],u=n.entries,i=0,a=u.length;a>i;i++)s=u[i],"folder"===t?"folder"===s[".tag"]&&p.push({name:s.name,id:s.path_lower,mimeType:s[".tag"],isFolder:"folder"===s[".tag"]}):p.push({name:s.name,id:s.path_lower,mimeType:s[".tag"],isFolder:"folder"===s[".tag"]});return o.resolve(p)}),o.promise},exports.getSpaceUsage=function(e){var r;return r=Promise.pending(),request({uri:"https://"+END_POINT+"/2/users/get_space_usage",auth:{bearer:e.access_token},method:"POST"},function(e,t,o){var n;return null!=e?r.reject(e):(n=JSON.parse(o),r.resolve({used:n.used,total:n.allocation.allocated}))}),r.promise},exports.getFileMetaData=function(e,r){return processGetRequest(e.access_token,"https://content.dropboxapi.com/1/files/auto/"+encodeURIComponent(r),function(e,r){var t;return t=JSON.parse(r.headers["x-dropbox-metadata"]),t.fileName=t.path.substring(t.path.lastIndexOf("/")+1),t})},exports.downloadFile=function(e,r){return request({uri:"https://content.dropboxapi.com/1/files/auto/"+encodeURIComponent(r),auth:{bearer:e.access_token},method:"GET"})},exports.deleteFile=function(e,r){var t;return t=Promise.pending(),request({uri:"https://api.dropboxapi.com/2/files/delete",auth:{bearer:e.access_token},headers:{"Content-Type":"application/json"},json:!0,body:{path:"/"+r},method:"POST"},function(e,r,o){return null!=e?t.reject(e):t.resolve(o)}),t.promise},exports.uploadDrive=function(e,r,t){var o,n;return o=Promise.pending(),n="https://content.dropboxapi.com/1/files_put/auto",null!=t&&(n+=encodeURIComponent(t)),n+="/"+r.originalname,request({uri:n,auth:{bearer:e.access_token},method:"POST",body:fs.readFileSync(r.path)},function(e,t,n){var s;return null!=e?o.reject(e):(s={url:"https://www.dropbox.com/home/Camera%C2%A0Uploads?preview="+r.originalname},o.resolve(s))}),o.promise},exports.getOAuthURL=function(){return"https://www.dropbox.com/1/oauth2/authorize?client_id="+DROPBOX_APP_KEY+"&redirect_uri="+DROPBOX_REDIRECT_URI+"&response_type=code"},getUserInfo=function(e){return processGetRequest(e.access_token,"https://"+END_POINT+"/1/account/info",function(e){return{userName:JSON.parse(e).display_name}})},processGetRequest=function(e,r,t){var o;return o=Promise.pending(),request({uri:r,auth:{bearer:e},method:"GET"},function(e,r,n){return null!=e?o.reject(e):o.resolve(t(n,r))}),o.promise},exports.createShareLink=function(e,r){var t;return t=Promise.pending(),request({uri:"api.dropboxapi.com/2/sharing/create_shared_link",auth:{bearer:e.access_token},json:!0,form:{path:encodeURIComponent("/"+r)},method:"POST"},function(e,r,o){return console.log("createShareLink response: ",r),null!=e?t.reject(e):t.resolve(JSON.parse(o).url)}),t.promise};