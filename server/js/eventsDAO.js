var EventsDAO,MongoClient,ObjectID,Q,chainedEventsCollection,createEvent,deleteEvent,getDB,getEventToSave,retrieveEvent,retrieveEvents,retrieveEventsByQuery,schedule,scheduledEventsCollection,tracedEventsCollection,updateEvent,uri;schedule=require("node-schedule"),Q=require("q"),MongoClient=require("mongodb").MongoClient,ObjectID=require("mongodb").ObjectID,uri=process.env.MONGOLAB_URI,scheduledEventsCollection="scheduledEvents",chainedEventsCollection="chainedEvents",tracedEventsCollection="tracedEvents",getDB=function(e){return MongoClient.connect(uri,function(t,n){if(t)throw t;return e(n)})},createEvent=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){return o.collection(t).insert(e,function(t,i){return o.close(),t?r.reject(new Error(t)):(void 0!==n&&n(i),r.resolve(e.eventId))})}),r.promise},updateEvent=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){return o.collection(n).update(e,t,function(e,t){return o.close(),e?r.reject(e):r.resolve(t.result.nModified)})}),r.promise},getEventToSave=function(e,t,n,r,o){return{user:e,dateTime:(new Date).getTime(),eventType:t,eventParams:n,providers:r,providersOptions:o}},deleteEvent=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){return o.collection(t).remove(e,function(e,t){return o.close(),e?r.reject(new Error(e)):(void 0!==n&&n(t),r.resolve(t.result.n))})}),r.promise},retrieveEvent=function(e,t){var n;return n=Q.defer(),getDB(function(r){return r.collection(t).findOne(e,function(e,t){return r.close(),e?n.reject(new Error(e)):n.resolve(t)})}),n.promise},retrieveEventsByQuery=function(e,t,n){var r;return r=Q.defer(),getDB(function(o){var i;return i={},n&&(i={sort:n}),o.collection(t).find(e,i).toArray(function(e,t){return o.close(),e?r.reject(new Error(e)):r.resolve(t)})}),r.promise},retrieveEvents=function(e,t){var n,r,o,i,c;if(n=Q.defer(),c={results:{$exists:!1},error:{$exists:!1}},void 0!==t)for(r=0,o=t.length;o>r;r++)i=t[r],c[i.name]=i.value;return getDB(function(t){return t.collection(e).find(c).toArray(function(e,r){return t.close(),e?n.reject(new Error(e)):n.resolve(r)})}),n.promise},module.exports=EventsDAO=function(){function e(){}return e.prototype.saveScheduledEvent=function(e,t,n,r,o,i,c){var v;return v={user:t,dateTime:new Date(n).getTime(),eventType:r,eventParams:c,providers:o,providersOptions:i,eventId:e,chainedEventsCounts:0},createEvent(v,scheduledEventsCollection)},e.prototype.createChainedEvent=function(e,t,n,r,o,i){var c;return c={user:t,eventType:n,eventParams:i,providers:r,eventParentId:e,providersOptions:o},createEvent(c,chainedEventsCollection,function(){return updateEvent(e,{$inc:{chainedEventsCounts:1}},scheduledEventsCollection)})},e.prototype.createTracedEvent=function(e,t,n,r,o,i){var c;return c=getEventToSave(e,t,n,r,o),c.results=i,createEvent(c,tracedEventsCollection)},e.prototype.createTracedEventError=function(e,t,n,r,o,i){var c;return c=getEventToSave(e,t,n,r,o),c.error=i,createEvent(c,tracedEventsCollection)},e.prototype.updateScheduledEvent=function(e,t){return delete t._id,updateEvent({eventId:e},t,scheduledEventsCollection)},e.prototype.updateScheduledEventAfterExecution=function(e,t){return updateEvent({eventId:e},{$set:{results:t}},scheduledEventsCollection)},e.prototype.updateScheduledEventAfterError=function(e,t){return updateEvent({eventId:e},{$set:{error:t.toString()}},scheduledEventsCollection)},e.prototype.updateChainedEventAfterExecution=function(e,t){return updateEvent({_id:new ObjectID(e)},{$set:{results:t}},chainedEventsCollection)},e.prototype.updateChainedEventAfterError=function(e,t){return updateEvent({_id:new ObjectID(e)},{$set:{error:t.toString()}},chainedEventsCollection)},e.prototype.deleteScheduledEvent=function(e){return deleteEvent({eventId:e},scheduledEventsCollection)},e.prototype.deleteChainedEvent=function(e,t){var n;return n={_id:new ObjectID(e)},deleteEvent(n,chainedEventsCollection,function(e){return 1===e.result.ok?updateEvent(t,{$inc:{chainedEventsCounts:-1}},scheduledEventsCollection):void 0})},e.prototype.deleteTracedEvent=function(e){var t;return t={_id:new ObjectID(e)},deleteEvent(t,tracedEventsCollection)},e.prototype.retrieveScheduledEvents=function(){return retrieveEvents(scheduledEventsCollection)},e.prototype.retrieveChainedEvents=function(e){return retrieveEvents(chainedEventsCollection,[{name:"eventParentId",value:e}])},e.prototype.retrieveScheduledEventsByUser=function(e){return retrieveEventsByQuery({user:e},scheduledEventsCollection,"dateTime")},e.prototype.retrieveTracedEventsByUser=function(e){return retrieveEventsByQuery({user:e},tracedEventsCollection,"dateTime")},e.prototype.retrieveScheduledEvent=function(e){return retrieveEvent({eventId:e},scheduledEventsCollection)},e.prototype.retrieveChainedEvent=function(e){return retrieveEvent({_id:new ObjectID(e)},chainedEventsCollection)},e}();